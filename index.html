<script src="https://code.jquery.com/jquery-2.1.3.js"></script>
<script src="./d3.js"></script>
<script src="./chart_test_d3.js"></script>

<style>
body{
    background: black;
}

.axis path {
    fill: none;
    stroke: none;
    /*shape-rendering: crispEdges;*/
}
.axis text {
    font-family: monospace;
    font-size: 13px;
    fill: white;
}
</style>

<svg id="visualisation" width="750" height="375"></svg>



<script>


ddd = [
 { "Timestamp" :1424269963,"close" :0.1250,"high" :0.1250,"low" :0.1250,"open" :0.1250,"volume" :60900 } 
, { "Timestamp" :1424270127,"close" :0.1200,"high" :0.1250,"low" :0.1200,"open" :0.1250,"volume" :438900 } 
, { "Timestamp" :1424270278,"close" :0.1200,"high" :0.1200,"low" :0.1200,"open" :0.1200,"volume" :120000 } 
, { "Timestamp" :1424270465,"close" :0.1200,"high" :0.1200,"low" :0.1200,"open" :0.1200,"volume" :20500 } 
, { "Timestamp" :1424270702,"close" :0.1200,"high" :0.1200,"low" :0.1200,"open" :0.1200,"volume" :45000 } 
, { "Timestamp" :1424271047,"close" :0.1200,"high" :0.1200,"low" :0.1200,"open" :0.1200,"volume" :0 } 
, { "Timestamp" :1424271099,"close" :0.1200,"high" :0.1200,"low" :0.1200,"open" :0.1200,"volume" :50000 } 
, { "Timestamp" :1424271163,"close" :0.1150,"high" :0.1150,"low" :0.1150,"open" :0.1150,"volume" :10000 } 
, { "Timestamp" :1424271293,"close" :0.1200,"high" :0.1200,"low" :0.1200,"open" :0.1200,"volume" :169000 } 
, { "Timestamp" :1424271327,"close" :0.1200,"high" :0.1200,"low" :0.1200,"open" :0.1200,"volume" :45500 } 
, { "Timestamp" :1424271477,"close" :0.1200,"high" :0.1200,"low" :0.1200,"open" :0.1200,"volume" :10000 } 
, { "Timestamp" :1424271491,"close" :0.1200,"high" :0.1200,"low" :0.1200,"open" :0.1200,"volume" :6000 } 
, { "Timestamp" :1424271559,"close" :0.1150,"high" :0.1200,"low" :0.1150,"open" :0.1200,"volume" :10000 } 
, { "Timestamp" :1424271706,"close" :0.1200,"high" :0.1200,"low" :0.1200,"open" :0.1200,"volume" :3000 } 
, { "Timestamp" :1424272135,"close" :0.1200,"high" :0.1200,"low" :0.1200,"open" :0.1200,"volume" :18000 } 
, { "Timestamp" :1424272233,"close" :0.1200,"high" :0.1200,"low" :0.1200,"open" :0.1200,"volume" :2000 } 
, { "Timestamp" :1424272561,"close" :0.1200,"high" :0.1200,"low" :0.1200,"open" :0.1200,"volume" :1000 } 
, { "Timestamp" :1424272709,"close" :0.1200,"high" :0.1200,"low" :0.1200,"open" :0.1200,"volume" :9800 } 
, { "Timestamp" :1424273224,"close" :0.1200,"high" :0.1200,"low" :0.1200,"open" :0.1200,"volume" :0 } 
, { "Timestamp" :1424273991,"close" :0.1200,"high" :0.1200,"low" :0.1200,"open" :0.1200,"volume" :24000 } 
, { "Timestamp" :1424274147,"close" :0.1250,"high" :0.1250,"low" :0.1250,"open" :0.1250,"volume" :6600 } 
, { "Timestamp" :1424274316,"close" :0.1250,"high" :0.1250,"low" :0.1250,"open" :0.1250,"volume" :0 } 
, { "Timestamp" :1424275374,"close" :0.1200,"high" :0.1200,"low" :0.1200,"open" :0.1200,"volume" :160500 } 
, { "Timestamp" :1424275408,"close" :0.1200,"high" :0.1200,"low" :0.1200,"open" :0.1200,"volume" :0 } 
, { "Timestamp" :1424275448,"close" :0.1200,"high" :0.1200,"low" :0.1200,"open" :0.1200,"volume" :26000 } 
, { "Timestamp" :1424275750,"close" :0.1200,"high" :0.1200,"low" :0.1200,"open" :0.1200,"volume" :12500 } 
, { "Timestamp" :1424276302,"close" :0.1250,"high" :0.1250,"low" :0.1250,"open" :0.1250,"volume" :1500 } 
, { "Timestamp" :1424276500,"close" :0.1250,"high" :0.1250,"low" :0.1250,"open" :0.1250,"volume" :0 } 
, { "Timestamp" :1424277439,"close" :0.1250,"high" :0.1250,"low" :0.1250,"open" :0.1250,"volume" :0 } 
, { "Timestamp" :1424277594,"close" :0.1250,"high" :0.1250,"low" :0.1250,"open" :0.1250,"volume" :0 } 
, { "Timestamp" :1424278457,"close" :0.1250,"high" :0.1250,"low" :0.1250,"open" :0.1250,"volume" :16100 } 
, { "Timestamp" :1424278688,"close" :0.1250,"high" :0.1250,"low" :0.1250,"open" :0.1250,"volume" :0 } 
, { "Timestamp" :1424278904,"close" :0.1250,"high" :0.1250,"low" :0.1250,"open" :0.1250,"volume" :20000 } 
, { "Timestamp" :1424279782,"close" :0.1250,"high" :0.1250,"low" :0.1250,"open" :0.1250,"volume" :0 } 
, { "Timestamp" :1424280835,"close" :0.1250,"high" :0.1250,"low" :0.1250,"open" :0.1250,"volume" :98000 } 
, { "Timestamp" :1424280878,"close" :0.1250,"high" :0.1250,"low" :0.1250,"open" :0.1250,"volume" :0 } 
, { "Timestamp" :1424281176,"close" :0.1250,"high" :0.1250,"low" :0.1250,"open" :0.1250,"volume" :13600 } 
, { "Timestamp" :1424281492,"close" :0.1250,"high" :0.1250,"low" :0.1250,"open" :0.1250,"volume" :2400 } 
, { "Timestamp" :1424281975,"close" :0.1250,"high" :0.1250,"low" :0.1250,"open" :0.1250,"volume" :0 } 
, { "Timestamp" :1424282365,"close" :0.1250,"high" :0.1250,"low" :0.1250,"open" :0.1250,"volume" :40000 } 
, { "Timestamp" :1424282417,"close" :0.1250,"high" :0.1250,"low" :0.1250,"open" :0.1250,"volume" :20000 } 
, { "Timestamp" :1424282461,"close" :0.1250,"high" :0.1250,"low" :0.1250,"open" :0.1250,"volume" :40000 } 
, { "Timestamp" :1424282675,"close" :0.1250,"high" :0.1250,"low" :0.1250,"open" :0.1250,"volume" :14400 } 
, { "Timestamp" :1424282838,"close" :0.1200,"high" :0.1200,"low" :0.1200,"open" :0.1200,"volume" :10000 } 
, { "Timestamp" :1424283008,"close" :0.1250,"high" :0.1250,"low" :0.1250,"open" :0.1250,"volume" :79000 } 
, { "Timestamp" :1424283071,"close" :0.1250,"high" :0.1250,"low" :0.1250,"open" :0.1250,"volume" :0 } 
, { "Timestamp" :1424283959,"close" :0.1250,"high" :0.1250,"low" :0.1250,"open" :0.1250,"volume" :4000 } 
, { "Timestamp" :1424284007,"close" :0.1250,"high" :0.1250,"low" :0.1250,"open" :0.1250,"volume" :47000 } 
, { "Timestamp" :1424284168,"close" :0.1250,"high" :0.1250,"low" :0.1250,"open" :0.1250,"volume" :0 } 
, { "Timestamp" :1424284391,"close" :0.1250,"high" :0.1250,"low" :0.1250,"open" :0.1250,"volume" :25000 } 
, { "Timestamp" :1424284485,"close" :0.1250,"high" :0.1250,"low" :0.1250,"open" :0.1250,"volume" :25000 } 
, { "Timestamp" :1424284536,"close" :0.1250,"high" :0.1250,"low" :0.1250,"open" :0.1250,"volume" :12500 } 
, { "Timestamp" :1424285151,"close" :0.1250,"high" :0.1250,"low" :0.1250,"open" :0.1250,"volume" :800 } 
, { "Timestamp" :1424285266,"close" :0.1250,"high" :0.1250,"low" :0.1250,"open" :0.1250,"volume" :0 } 
, { "Timestamp" :1424285341,"close" :0.1200,"high" :0.1200,"low" :0.1200,"open" :0.1200,"volume" :15000 } 
, { "Timestamp" :1424285610,"close" :0.1200,"high" :0.1250,"low" :0.1200,"open" :0.1250,"volume" :24500 } 
, { "Timestamp" :1424286099,"close" :0.1250,"high" :0.1250,"low" :0.1250,"open" :0.1250,"volume" :44500 } 
, { "Timestamp" :1424286363,"close" :0.1250,"high" :0.1250,"low" :0.1250,"open" :0.1250,"volume" :100 } 
, { "Timestamp" :1424287308,"close" :0.1250,"high" :0.1250,"low" :0.1250,"open" :0.1250,"volume" :0 } 
, { "Timestamp" :1424287461,"close" :0.1250,"high" :0.1250,"low" :0.1250,"open" :0.1250,"volume" :0 } 
, { "Timestamp" :1424288560,"close" :0.1250,"high" :0.1250,"low" :0.1250,"open" :0.1250,"volume" :0 } 
, { "Timestamp" :1424288629,"close" :0.1250,"high" :0.1250,"low" :0.1250,"open" :0.1250,"volume" :20000 } 
, { "Timestamp" :1424288787,"close" :0.1250,"high" :0.1250,"low" :0.1250,"open" :0.1250,"volume" :12000 } 
, { "Timestamp" :1424289180,"close" :0.1200,"high" :0.1200,"low" :0.1200,"open" :0.1200,"volume" :10500 } 
, { "Timestamp" :1424289405,"close" :0.1200,"high" :0.1200,"low" :0.1200,"open" :0.1200,"volume" :185000 } 
, { "Timestamp" :1424289659,"close" :0.1200,"high" :0.1200,"low" :0.1200,"open" :0.1200,"volume" :0 } 
, { "Timestamp" :1424289984,"close" :0.1250,"high" :0.1250,"low" :0.1250,"open" :0.1250,"volume" :173900 } 
, { "Timestamp" :1424290069,"close" :0.1250,"high" :0.1250,"low" :0.1250,"open" :0.1250,"volume" :108000 } 
, { "Timestamp" :1424290248,"close" :0.1250,"high" :0.1250,"low" :0.1250,"open" :0.1250,"volume" :50000 } 
, { "Timestamp" :1424290279,"close" :0.1250,"high" :0.1250,"low" :0.1250,"open" :0.1250,"volume" :1500 } 
, { "Timestamp" :1424290367,"close" :0.1300,"high" :0.1300,"low" :0.1300,"open" :0.1300,"volume" :47400 } 
, { "Timestamp" :1424290759,"close" :0.1300,"high" :0.1300,"low" :0.1300,"open" :0.1300,"volume" :0 } 
, { "Timestamp" :1424290964,"close" :0.1250,"high" :0.1250,"low" :0.1250,"open" :0.1250,"volume" :226500 } 
, { "Timestamp" :1424291436,"close" :0.1250,"high" :0.1250,"low" :0.1250,"open" :0.1250,"volume" :57000 } 
, { "Timestamp" :1424291705,"close" :0.1250,"high" :0.1250,"low" :0.1250,"open" :0.1250,"volume" :26500 } 
, { "Timestamp" :1424291789,"close" :0.1250,"high" :0.1250,"low" :0.1250,"open" :0.1250,"volume" :15500 } 
, { "Timestamp" :1424291860,"close" :0.1250,"high" :0.1250,"low" :0.1250,"open" :0.1250,"volume" :0 } 
, { "Timestamp" :1424292204,"close" :0.1250,"high" :0.1250,"low" :0.1250,"open" :0.1250,"volume" :8200 } 
, { "Timestamp" :1424292313,"close" :0.1300,"high" :0.1300,"low" :0.1300,"open" :0.1300,"volume" :179500 } 
, { "Timestamp" :1424292387,"close" :0.1250,"high" :0.1250,"low" :0.1250,"open" :0.1250,"volume" :10000 } 
, { "Timestamp" :1424292828,"close" :0.1300,"high" :0.1300,"low" :0.1300,"open" :0.1300,"volume" :24000 } 
, { "Timestamp" :1424292857,"close" :0.1250,"high" :0.1250,"low" :0.1250,"open" :0.1250,"volume" :13000 } 
, { "Timestamp" :1424292963,"close" :0.1250,"high" :0.1250,"low" :0.1250,"open" :0.1250,"volume" :0 } 
, { "Timestamp" :1424293069,"close" :0.1300,"high" :0.1300,"low" :0.1300,"open" :0.1300,"volume" :80000 } 
, { "Timestamp" :1424293111,"close" :0.1350,"high" :0.1350,"low" :0.1250,"open" :0.1250,"volume" :401800 } 
, { "Timestamp" :1424293200,"close" :0.1350,"high" :0.1350,"low" :0.1350,"open" :0.1350,"volume" :15500 } 

]

Array.prototype.first = function(){
    return this[0];
}

Array.prototype.last = function(){
    return this[this.length-1];
}

var Historical = function(symbol, date, open, close, high, low, volume){
    this.symbol = symbol;
    this.date   = date;
    this.open   = open;
    this.close  = close;
    this.high   = high;
    this.low    = low;
    this.volume = volume;
}

// We will already have JSON from server so we won't need to wrap it like this.

$.getJSON('./data/yahoo_historical.json', function(data) {
    var quoteObjects = [];
    var MAXy = 0;
    var MINy = 666666666666;
    // var quotes = data.query.results.quote
    var quotes = ddd;
    quotes.forEach(function(quote){

        if (quote.close > MAXy){
        // if (quote.Close > MAXy){
            // MAXy = quote.Close;
            MAXy = quote.close;
        }
        if (quote.close < MINy){
        // if (quote.Close < MINy){
            // MINy = quote.Close;
            MINy = quote.close;
        }

        quoteObjects.push(new Historical(
            // quote.Symbol,
            // new Date(quote.Date),
            null,
            new Date(quote.Timestamp*1000),
            quote.open,
            quote.close,
            quote.high,
            quote.low,
            quote.volume
            // quote.Open,
            // quote.Close,
            // quote.High,
            // quote.Low,
            // quote.Volume
        ));
    });
    quoteObjects.sort(function(x,y){
        return x.date - y.date
    });

    // $('#visualisation').width($(window).width())
    // $('#visualisation').height($(window).width()/2)


    var vis = d3.select("#visualisation"),
    WIDTH = $('#visualisation').width() - 100,
    HEIGHT = ($('#visualisation').width() - 100) / 2,
    MARGINS = {
        top: 20,
        right: 20,
        bottom: 20,
        left: 40,
    },
    xScale = d3.time.scale().range([MARGINS.left, WIDTH - MARGINS.right]).domain([quoteObjects.first().date,quoteObjects.last().date]),
    yScale = d3.scale.linear().range([HEIGHT - MARGINS.top, MARGINS.bottom]).domain([MINy,MAXy]),
    xAxis = d3.svg.axis()
        .scale(xScale),
    yAxis = d3.svg.axis()
        .scale(yScale)
        .orient("left");



    vis.append("svg:g")
        .attr("class","axis")
        .attr("transform", "translate(0," + (HEIGHT - MARGINS.bottom) + ")")
        .call(xAxis);

    vis.append("svg:g")
        .attr("class","axis")
        .attr("transform", "translate(" + (MARGINS.left) + ",0)")
        .call(yAxis);



    // manipulate position of months

    d3.selectAll(".axis:nth-child(1) .tick").each(function(datum){
        var month = d3.select(this);
        var old_attr = month.attr('transform')
        var x_translation = parseFloat(old_attr.split('(')[1].split(',')[0])
        x_translation += 20
        month.attr('transform', "translate("+x_translation+",20) rotate(45 0 0)")
    })


    var lineGen = d3.svg.line()
      .x(function(d) {
        return xScale(d.date);
      })
      .y(function(d) {
        return yScale(d.open);
      })
      .interpolate("basis");

    var lineGen2 = d3.svg.line()
      .x(function(d) {
        return xScale(d.date);
      })
      .y(function(d) {
        return yScale(d.close);
      })
      .interpolate("basis");


// close
    vis.append('svg:path')
      .attr('d', lineGen2(quoteObjects))
      .attr('stroke', 'red')
      .attr('stroke-width', 1)
      .attr('fill', '#111');

// open
    // vis.append('svg:path')
    //   .attr('d', lineGen(quoteObjects))
    //   .attr('stroke', 'blue')
    //   .attr('stroke-width', 1)
    //   .attr('fill', 'none');

     var focus = vis.append("svg:g")                                
        .style("display", "none");                             



console.log(quoteObjects)

var parseDate = d3.time.format("%d-%b-%y").parse,
    // formatDate = d3.time.format("%b-%d-%y"),
    formatDate = d3.time.format("%X"),
    bisectDate = d3.bisector(function(d) { return d.date; }).left; // **






   // append the x line
    focus.append("line")
        .attr("class", "x")
        .style("stroke", "white")
        .style("stroke-dasharray", "3,3")
        .style("opacity", 0.5)
        .attr("y1", 0)
        .attr("y2", HEIGHT);

    // append the y line
    focus.append("line")
        .attr("class", "y")
        .style("stroke", "white")
        .style("stroke-dasharray", "3,3")
        .style("opacity", 0.5)
        .attr("x1", WIDTH)
        .attr("x2", WIDTH);

    // append the circle at the intersection
    focus.append("circle")
        .attr("class", "y")
        .style("fill", "white")
        .style("stroke", "white")
        .attr("r", 4);

    // place the value at the intersection
    focus.append("text")
        .attr("class", "y1")
        .style("stroke", "none")
        .style("fill", "white")
        .style("font-family", "monospace")
        // .style("stroke-width", "3.5px")
        .style("opacity", 0.8)
        .attr("dx", 8)
        .attr("dy", "-.3em");

    // focus.append("text")
    //     .attr("class", "y2")
    //     .attr("dx", 8)
    //     .attr("dy", "-.3em");

    // place the date at the intersection
    focus.append("text")
        .attr("class", "y3")
        .style("stroke", "none")
        .style("fill", "white")
        .style("font-family", "monospace")
        .style("opacity", 0.8)
        .attr("dx", 8)
        .attr("dy", "1em");

    // focus.append("text")
    //     .attr("class", "y4")
    //     .attr("dx", 8)
    //     .attr("dy", "1em");




    // append the rectangle to capture mouse
    vis.append("rect")
        .attr("width", WIDTH)
        .attr("height", HEIGHT)
        .style("fill", "none")
        .style("pointer-events", "all")
        .on("mouseover", function() { focus.style("display", null); })
        .on("mouseout", function() { focus.style("display", "none"); })
        .on("touchend", function() { focus.style("display", "none"); })
        .on("mousemove", mousemove)
        .on("touchmove", mousemove);


    function mousemove() {
        var x0 = xScale.invert(d3.mouse(this)[0]),
            i = bisectDate(quoteObjects, x0, 1),
            d0 = quoteObjects[i - 1],
            d1 = quoteObjects[i];

        if (d1) {
           var d = x0 - d0.date > d1.date - x0 ? d1 : d0;

            focus.select("circle.y")
                .attr("transform",
                      "translate(" + xScale(d.date) + "," +
                                     yScale(d.close) + ")");

            focus.select("text.y1")
              .attr("transform",
                    "translate(" + xScale(d.date) + "," +
                                   yScale(d.close) + ")")
              .text(d.close);

            // focus.select("text.y2")
            //   .attr("transform",
            //         "translate(" + xScale(d.date) + "," +
            //                        yScale(d.close) + ")")
            //   .text(d.close);

            focus.select("text.y3")
              .attr("transform",
                    "translate(" + xScale(d.date) + "," +
                                   yScale(d.close) + ")")
              .text(formatDate(d.date));

            // focus.select("text.y4")
            //   .attr("transform",
            //         "translate(" + xScale(d.date) + "," +
            //                        yScale(d.close) + ")")
            //   .text(formatDate(d.date));

            focus.select(".x")
              .attr("transform",
                    "translate(" + xScale(d.date) + "," +
                                   yScale(d.close) + ")")
                         .attr("y2", HEIGHT - yScale(d.close));


            focus.select(".y")
              .attr("transform",
                    "translate(" + WIDTH * -1 + "," +
                                   yScale(d.close) + ")")
                         .attr("x2", WIDTH + WIDTH);
        }
    }
});

</script>